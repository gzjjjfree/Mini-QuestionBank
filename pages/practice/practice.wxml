<!-- practice/practice.wxml -->
<wxs src="./utils.wxs" module="utils" />

<wxs src="./highlight.wxs" module="highlight" />

<view class="practice-container">
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <view class="navbar">
        <button class="back-btn" bindtap="goBack">
            <text class="back-icon">‚Üê</text>
            <text class="back-text">ËøîÂõû</text>
        </button>
        <view class="title">{{pageTitle}}</view>
    </view>

    <!-- È°µÈù¢ÂÜÖÂÆπ -->
    <view class="content">
        <view class="practice-info">
            <text>üìñ{{excelData.displayName}}</text>
        </view>

        <!-- Ê†πÊçÆ‰∏çÂêåÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÂÜÖÂÆπ -->
        <view wx:if="{{practiceType === 'sequential' || 
        practiceType === 'wrong' || 
        practiceType === 'favorite' || 
        practiceType === 'editMode' || 
        practiceType === 'random'}}">
            <view wx:if="{{!showTypeFilter}}" class="question-list">
                <view wx:for="{{questionTypes}}" wx:key="*this" class="question-item" bindtap="selectQuestionType"
                    data-type="{{item}}">
                    <text>È¢òÁõÆ{{index + 1}}. ({{item}})</text>
                </view>
            </view>

            <!-- ÂΩì showTypeFilter ‰∏∫ true Êó∂ÊòæÁ§∫È¢òÁõÆÂíåÈÄâÈ°π -->
            <view wx:elif="{{showTypeFilter}}">
                <view class="touch-area" bindtouchstart="onTouchStart" bindtouchend="onTouchEnd">
                    <view class="questions-container">
                        <view class="question-card">
                            <view class="question-header">
                                <text class="question-number">ÊÄª{{sequentialIndex}}È¢ò {{sequentialType}}</text>
                                <view class="right-group">
                                    <text class="question-collect"
                                        bindtap="setCollect">{{isCollected ? '‚≠ê' : '‚òÜ'}}</text>
                                    <text class="question-difficulty">ÈöæÂ∫¶: {{sequentialDifficulty}}</text>
                                </view>
                            </view>


                            <block wx:if="{{!isEditMode}}">
                                <!--<view class="question-content">{{saveRecordIndex + 1}}.{{sequentialContent}}</view>-->
                                <text class="question-content">{{saveRecordIndex + 1}}.{{sequentialContent}}</text>
                            </block>
                            <block wx:else>
                                <textarea class="question-content" value="{{sequentialContent}}"
                                    bindinput="onEditContent" auto-height maxlength="-1" />
                            </block>

                            <!-- ÈÄâÈ°πÂå∫ -->
                            <view class="question-options">
                                <view wx:for="{{sequentialOptions}}" wx:key="index" class="option-row"
                                    wx:if="{{isEditMode ? (index <= utils.getLastContentIndex(sequentialOptions, sequentialType)) : item}}">
                                    <block wx:if="{{!isEditMode}}">
                                        <view class="option-item {{selectedOptionsClass[index]}}" bindtap="selectOption"
                                            data-index="{{index}}">
                                            <text wx:if="{{ sequentialType != 'Â°´Á©∫È¢ò' && sequentialType != 'ÈóÆÁ≠îÈ¢ò' }}"
                                                class="option-label">{{['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'][index]}}.</text>
                                            <text class="option-text">{{item}}</text>
                                            <!-- Ê≠£Á°Æ/ÈîôËØØÂõæÊ†á -->
                                            <view wx:if="{{showAnswer}}" class="answer-icon">
                                                <text
                                                    wx:if="{{utils.goIncludes(selectedOptions, index) && utils.goIncludes(correctOptionIndex, index)}}"
                                                    class="icon-text correct-icon">‚úì</text>
                                                <text
                                                    wx:elif="{{(utils.goIncludes(selectedOptions, index) && !utils.goIncludes(correctOptionIndex, index)) || 
                                                (!utils.goIncludes(selectedOptions, index) && utils.goIncludes(correctOptionIndex, index) && isMultipleChoice)}}"
                                                    class="icon-text wrong-icon">‚úï</text>
                                            </view>
                                        </view>
                                    </block>
                                    <block wx:else>
                                        <view class="option-item" data-index="{{index}}">
                                            <block wx:if="{{ sequentialType != 'Â°´Á©∫È¢ò' && sequentialType != 'ÈóÆÁ≠îÈ¢ò' }}">
                                                <text
                                                    class="option-label">{{['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'][index]}}.</text>
                                                <textarea class="option-text-area" value="{{item}}"
                                                    data-index="{{index}}" placeholder="ËØ∑ËæìÂÖ•ÈÄâÈ°πÂÜÖÂÆπ..."
                                                    placeholder-style="color: #ccc;" bindinput="onEditOption"
                                                    auto-height maxlength="-1" />
                                            </block>
                                            <block wx:else>
                                                <textarea class="option-text-area"
                                                    style="{{sequentialType === 'ÈóÆÁ≠îÈ¢ò' ? 'text-align: left;' : ''}}"
                                                    value="{{exercises[saveRecord.index].options.A}}"
                                                    data-index="{{index}}" placeholder="ËØ∑ËæìÂÖ•ÈÄâÈ°πÂÜÖÂÆπ..."
                                                    placeholder-style="color: #ccc;" bindinput="onEditOption"
                                                    auto-height maxlength="-1" />
                                            </block>
                                        </view>
                                    </block>
                                </view>

                                <!-- ÊòæÁ§∫Á≠îÊ°à -->
                                <view
                                    wx:if="{{(showAnswer && !isEditMode) && (sequentialType === 'Â°´Á©∫È¢ò' || sequentialType === 'ÈóÆÁ≠îÈ¢ò')}}"
                                    class="memorize-answer" style="{{sequentialType === 'ÈóÆÁ≠îÈ¢ò' ? 'text-align: left;' : ''}}">
                                    <text>{{exercises[saveRecord.index].options.A}}</text>
                                </view>

                                <!-- Êèê‰∫§Á≠îÊ°àÊåâÈíÆÔºàÂ§öÈÄâÈ¢òÈúÄË¶ÅÔºâ -->
                                <view wx:if="{{isMultipleChoice && !isEditMode}}" class="submit-btn-container">
                                    <button class="submit-btn" bindtap="submitAnswer">Êèê‰∫§Á≠îÊ°à</button>
                                </view>

                                <!-- ‰øÆÊ≠£È¢òÁõÆÊåâÈíÆ -->
                                <view wx:if="{{isEditMode}}" class="submit-btn-container">
                                    <button class="footer-btns" bindtap="addOption">Â¢ûÂä†ÈÄâÈ°π</button>
                                    <button class="footer-btns" bindtap="saveCurrentQuestion">‰øùÂ≠òÊú¨È¢ò</button>
                                    <button class="footer-btns" bindtap="addNewQuestion">Êñ∞Â¢ûÈ¢òÁõÆ</button>
                                    <button class="footer-btns btn-delete" bindtap="deleteCurrentQuestion">Âà†Èô§Êú¨È¢ò</button>
                                </view>

                                <!-- ÂØºËà™ÊåâÈíÆ -->
                                <view class="navigation-buttons">
                                    <button class="nav-btn next-btn" bindtap="prevQuestion">‰∏ä‰∏ÄÈ¢ò</button>
                                    <button class="nav-btn next-btn" bindtap="nextQuestion">‰∏ã‰∏ÄÈ¢ò</button>
                                </view>
                            </view>

                            <!-- Âõ∫ÂÆöÂú®Â∫ïÈÉ®ÁöÑÊåâÈíÆ -->
                            <view class="fixed-bottom-buttons">
                                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                                <view class="stats-info">
                                    <text>ÊÄªÊï∞: {{exercises.length}}</text>
                                    <text>‚úì:{{questionStatuses.info.completedCount -
                                        questionStatuses.info.wrongCount}}</text>
                                    <text>‚úó: {{questionStatuses.info.wrongCount}}</text>
                                </view>

                                <!-- ËøîÂõûÈ¢òÂûãÂàóË°® -->
                                <view class="navigation-buttons">
                                    <button class="back-to-list" bindtap="goBackToTypeSelection">ËøîÂõûÈ¢òÂûã</button>
                                    <button class="back-to-list" bindtap="goQuestions">È¢òÁõÆÂàóË°®</button>
                                    <button class="back-to-list" bindtap="delSequential">Âà†Èô§ËÆ∞ÂΩï</button>
                                </view>
                            </view>

                            <!-- È¢òÁõÆÂàóË°®ÂºπÁ™ó -->
                            <view wx:if="{{showQuestionList}}" class="question-list-modal">
                                <view class="modal-mask" bindtap="closeQuestionList"></view>
                                <view class="modal-content">
                                    <!-- ÂºπÁ™óÂ§¥ÈÉ® -->
                                    <view class="modal-header">
                                        <text class="modal-title">È¢òÁõÆÂàóË°®</text>
                                        <text class="close-btn" bindtap="closeQuestionList">√ó</text>
                                    </view>

                                    <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                                    <view class="stats-info">
                                        <text class="stat-item">ÊÄªÊï∞: {{exercises.length}}</text>
                                        <text class="stat-item">Â∑≤ÂÅö: {{questionStatuses.info.completedCount}}</text>
                                        <text class="stat-item">ÈîôÈ¢ò: {{questionStatuses.info.wrongCount}}</text>
                                    </view>

                                    <!-- È¢òÁõÆÂàóË°® -->
                                    <scroll-view class="question-list-scroll" scroll-y>
                                        <view class="question-grid">
                                            <view wx:for="{{exercises}}" wx:key="index"
                                                class="question-list-item {{index === saveRecordIndex ? 'current' : ''}} {{questionStatuses.status[index] === 'correct' ? 'completed' : ''}} {{questionStatuses.status[index] === 'wrong' ? 'wrong' : ''}}"
                                                bindtap="selectQuestionFromList" data-index="{{index}}">
                                                <text class="question-number">{{index + 1}}</text>

                                                <!-- ‰ΩøÁî®Áªü‰∏ÄÁöÑÁä∂ÊÄÅÊòæÁ§∫ -->
                                                <view wx:if="{{questionStatuses.status[index] === 'correct'}}"
                                                    class="status-dot completed"></view>
                                                <view wx:if="{{questionStatuses.status[index] === 'wrong'}}"
                                                    class="status-dot wrong"></view>
                                            </view>
                                        </view>
                                    </scroll-view>

                                    <!-- ÂΩìÂâçÈ¢òÁõÆÊ†áËÆ∞ -->
                                    <view class="current-indicator">
                                        <text>ÂΩìÂâç: Á¨¨{{saveRecordIndex + 1}}È¢ò</text>
                                    </view>
                                </view>
                            </view>

                        </view>
                    </view>
                </view>
            </view>

        </view>

        <view wx:elif="{{practiceType === 'search'}}">
            <view class="search-box">
                <input class="search-input" placeholder="ËØ∑ËæìÂÖ•È¢òÁõÆÂÖ≥ÈîÆËØç" bindinput="onSearchInput"
                    value="{{searchKeyword}}" />
                <button class="search-btn" bindtap="onSearch">ÊêúÁ¥¢</button>
            </view>

            <!-- È¢òÂûãÁ≠õÈÄâÈù¢Êùø - ÁΩëÊ†ºÂ∏ÉÂ±Ä -->
            <view class="type-filter-panel">
                <view wx:for="{{questionTypes}}" wx:key="*this"
                    class="type-item {{selectedQuestionType === item ? 'active' : ''}}" bindtap="searchQuestionType"
                    data-type="{{item}}">
                    <text class="type-text">{{item}}</text>
                    <view wx:if="{{selectedQuestionType === item}}" class="type-check">‚úì</view>
                </view>
            </view>

            <view class="search-results">
                <view wx:if="{{useQuestions.length === 0 && searchKeyword}}">
                    <text class="no-result">Êú™ÊâæÂà∞Áõ∏ÂÖ≥È¢òÁõÆ</text>
                </view>
                <view wx:if="{{useQuestions.length > 0 && searchKeyword}}">
                    <text class="no-result">ÊâæÂà∞ {{useQuestions.length}} ‰∏™ÁªìÊûú</text>

                    <view wx:for="{{useQuestions}}" wx:key="index" class="question-card">
                        <view class="question-header">
                            <text class="question-number">Á¨¨{{item.id}}È¢ò</text>
                            <text class="question-type">{{item.type}}</text>
                        </view>

                        <!-- ÂéüÊù•ÁöÑ‰ª£Á†ÅÔºö<view class="question-content">{{item[2]}}</view> -->
                        <view class="question-content">
                            <rich-text nodes="{{highlight.highlight(item.content, searchKeyword)}}">
                            </rich-text>
                        </view>

                        <!-- ÈÄâÈ°π - Âπ∂ÂàóÊòæÁ§∫ÔºåÊîØÊåÅÂ§öÈÄâÈ¢òÊ≠£Á°ÆÁ≠îÊ°à -->
                        <view class="question-options">
                            <view class="option-row">
                                <view wx:if="{{item.options.A}}"
                                    class="search_option-item {{utils.isCorrectAnswer(item.answer, 'A') ? 'correct-option' : ''}}">
                                    A. {{item.options.A}}
                                </view>
                                <view wx:if="{{item.options.B}}"
                                    class="search_option-item {{utils.isCorrectAnswer(item.answer, 'B') ? 'correct-option' : ''}}">
                                    B. {{item.options.B}}
                                </view>
                            </view>
                            <view class="option-row">
                                <view wx:if="{{item.options.C}}"
                                    class="search_option-item {{utils.isCorrectAnswer(item.answer, 'C') ? 'correct-option' : ''}}">
                                    C. {{item.options.C}}
                                </view>
                                <view wx:if="{{item.options.D}}"
                                    class="search_option-item {{utils.isCorrectAnswer(item.answer, 'D') ? 'correct-option' : ''}}">
                                    D. {{item.options.D}}
                                </view>
                            </view>
                        </view>
                    </view>
                </view>
            </view>
        </view>
    </view>
</view>